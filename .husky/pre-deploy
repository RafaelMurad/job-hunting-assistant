#!/usr/bin/env bash
# Pre-deployment validation hook
# This runs BEFORE Vercel builds to ensure only production-ready code deploys

set -e  # Exit on any error

echo "üîç Pre-Deployment Validation Starting..."
echo "========================================"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any checks fail
VALIDATION_FAILED=0

# 1. Environment Check
echo ""
echo "üìã Step 1/6: Checking Environment Variables..."
if [ -z "$DATABASE_URL" ]; then
  echo -e "${RED}‚ùå DATABASE_URL is not set${NC}"
  VALIDATION_FAILED=1
else
  echo -e "${GREEN}‚úÖ DATABASE_URL is set${NC}"
fi

if [ -z "$AI_PROVIDER" ]; then
  echo -e "${RED}‚ùå AI_PROVIDER is not set${NC}"
  VALIDATION_FAILED=1
else
  echo -e "${GREEN}‚úÖ AI_PROVIDER is set to: $AI_PROVIDER${NC}"
  
  # Check corresponding API key is set
  case "$AI_PROVIDER" in
    "gemini")
      if [ -z "$GEMINI_API_KEY" ]; then
        echo -e "${RED}‚ùå GEMINI_API_KEY is not set but AI_PROVIDER is gemini${NC}"
        VALIDATION_FAILED=1
      else
        echo -e "${GREEN}‚úÖ GEMINI_API_KEY is set${NC}"
      fi
      ;;
    "openai")
      if [ -z "$OPENAI_API_KEY" ]; then
        echo -e "${RED}‚ùå OPENAI_API_KEY is not set but AI_PROVIDER is openai${NC}"
        VALIDATION_FAILED=1
      else
        echo -e "${GREEN}‚úÖ OPENAI_API_KEY is set${NC}"
      fi
      ;;
    "claude")
      if [ -z "$ANTHROPIC_API_KEY" ]; then
        echo -e "${RED}‚ùå ANTHROPIC_API_KEY is not set but AI_PROVIDER is claude${NC}"
        VALIDATION_FAILED=1
      else
        echo -e "${GREEN}‚úÖ ANTHROPIC_API_KEY is set${NC}"
      fi
      ;;
  esac
fi

# 2. Code Formatting Check
echo ""
echo "üé® Step 2/6: Checking Code Formatting..."
if npm run format:check > /dev/null 2>&1; then
  echo -e "${GREEN}‚úÖ All files properly formatted${NC}"
else
  echo -e "${RED}‚ùå Code formatting issues detected${NC}"
  echo -e "${YELLOW}Run: npm run format${NC}"
  VALIDATION_FAILED=1
fi

# 3. Linting Check
echo ""
echo "üîç Step 3/6: Running ESLint (zero warnings allowed)..."
if npm run lint -- --max-warnings=0 > /dev/null 2>&1; then
  echo -e "${GREEN}‚úÖ No linting errors or warnings${NC}"
else
  echo -e "${RED}‚ùå Linting failed${NC}"
  echo -e "${YELLOW}Run: npm run lint:fix${NC}"
  VALIDATION_FAILED=1
fi

# 4. Type Check
echo ""
echo "üìò Step 4/6: Running TypeScript Type Check..."
if npm run type-check > /dev/null 2>&1; then
  echo -e "${GREEN}‚úÖ No TypeScript errors${NC}"
else
  echo -e "${RED}‚ùå TypeScript errors detected${NC}"
  echo -e "${YELLOW}Run: npm run type-check${NC}"
  VALIDATION_FAILED=1
fi

# 5. Database Migration Check
echo ""
echo "üóÑÔ∏è  Step 5/6: Checking Database Schema..."
if npx prisma validate > /dev/null 2>&1; then
  echo -e "${GREEN}‚úÖ Prisma schema is valid${NC}"
else
  echo -e "${RED}‚ùå Prisma schema validation failed${NC}"
  VALIDATION_FAILED=1
fi

# 6. Build Test
echo ""
echo "üèóÔ∏è  Step 6/6: Testing Production Build..."
if npm run build > /dev/null 2>&1; then
  echo -e "${GREEN}‚úÖ Production build successful${NC}"
else
  echo -e "${RED}‚ùå Production build failed${NC}"
  echo -e "${YELLOW}Run: npm run build${NC}"
  VALIDATION_FAILED=1
fi

# Final Result
echo ""
echo "========================================"
if [ $VALIDATION_FAILED -eq 1 ]; then
  echo -e "${RED}‚ùå PRE-DEPLOYMENT VALIDATION FAILED${NC}"
  echo ""
  echo "Your code is NOT production-ready. Fix the issues above before deploying."
  echo ""
  echo "Quick fix commands:"
  echo "  npm run format      # Fix formatting"
  echo "  npm run lint:fix    # Auto-fix linting"
  echo "  npm run type-check  # Check types"
  echo "  npm run validate    # Run all checks"
  echo ""
  exit 1
else
  echo -e "${GREEN}‚úÖ ALL CHECKS PASSED - READY FOR DEPLOYMENT${NC}"
  echo ""
  exit 0
fi
